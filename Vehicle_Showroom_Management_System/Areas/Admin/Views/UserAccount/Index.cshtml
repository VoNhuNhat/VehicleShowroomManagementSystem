@model IEnumerable<Vehicle_Showroom_Management_System.Areas.Admin.Data.UserAccount>


@{
    ViewBag.Title = "UserInformation";
    Layout = "~/Areas/Admin/Views/Shared/Index.cshtml";
}

<div class="container">
    <h2 style="text-align: center"><b>List of Users</b></h2>
    <br />
    <p>
        <a href="/Admin/UserAccount/Create" class="btn btn-primary"><b>Add new user</b></a>
        <input style="float: right" class="form-control col-md-4" name="searchUser" id="searchUser" type="text" placeholder="Search Fullname..." aria-label="Search" aria-describedby="basic-addon2" />
    </p>
    <table class="table table-bordered" id="tableUser">
        <tr>
            <th>
                <b>@Html.DisplayNameFor(model => model.FullName)</b>
            </th>
            <th>
                <b>@Html.DisplayNameFor(model => model.UserName)</b>
            </th>
            <th>
                <b>@Html.DisplayNameFor(model => model.Email)</b>
            </th>
            <th>
                <b>@Html.DisplayNameFor(model => model.PhoneNumber)</b>
            </th>
            <th></th>
        </tr>
        <tbody>
            @*@foreach (var item in Model)
            {
                <tr class="dataTable" id="@item.UserId">
                    <td>
                        @Html.DisplayFor(modelItem => item.FullName)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.UserName)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Email)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.PhoneNumber)
                    </td>
                    <td style="width: 250px;">
                        @Html.ActionLink("Details", "Details", new { userId = item.UserId }, new { @class = "btn btn-info", @style = "font-weight: bold" })
                        @Html.ActionLink("Edit", "Edit", new { userId = item.UserId }, new { @class = "btn btn-success", @style = "font-weight: bold" })
                        <a style="color: white" class="btn btn-danger" onclick="deleteUser(@item.UserId)"><b>Delete</b></a>
                    </td>
                </tr>
            }*@
        </tbody>
    </table>
    <div class="pagination" id="pagination" style="float: right">
    </div>
    <div class="pagination" id="paginationSearchMutiplePages" style="float: right">
    </div>
    <div class="pagination" id="paginationSearchOnePage" style="float: right">
    </div>
</div>

<script>
    var pageCofig = {
        pageSize: 2,
        pageIndex: 1
    }
    var pageSearchCofig = {
        pageSize: 2,
        pageIndex: 1
    }
    var pageSearchOneCofig = {
        pageSize: 1,
        pageIndex: 1
    }

    $(document).ready(function () {
        $("#pagination").hide();
        $("#paginationSearchMutiplePages").hide();
        $("#paginationSearchOnePage").hide();
        loadData();
    });
    function loadData() {
        $("#tableUser").find('.dataTable').remove();
        $.ajax({
            type: "GET",
            url: "/Admin/UserAccount/LoadData",
            data: {
                page: pageCofig.pageIndex,
                pageSize: pageCofig.pageSize
            },
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (response.data.length > 0) {
                var row = "";
                for (var i = 0; i < response.data.length; i++) {
                    row += "<tr class='dataTable' id='" + response.data[i].UserId + "'>" + "<td>" + response.data[i].FullName + "</td>" + "<td>" + response.data[i].UserName + "</td>" + "<td>" + response.data[i].Email + "</td>" + "<td>" + response.data[i].PhoneNumber + "</td>" + "<td> <a href='/Admin/UserAccount/Details/" + response.data[i].UserId + "' class='btn btn-info' style = 'font-weight: bold'>Details</a> <a href='/Admin/UserAccount/Edit/" + response.data[i].UserId + "' class='btn btn-success' style = 'font-weight: bold'>Edit</a> <a onclick = deleteUser(" + response.data[i].UserId + ") class='btn btn-danger' style = 'font-weight: bold; color: white'>Delete</a> </td>" + "</tr>"
                }
                    $("#tableUser").append(row);
                    $("#pagination").show();
                pagination(response.total, function () {
                    loadData();
                })
                }
            }
        });
    }
    function pagination(totalRow, callback) {
        var totalPage = Math.ceil(totalRow / pageCofig.pageSize);
        $('#pagination').twbsPagination({
            totalPages: totalPage,
            visiblePages: 10,
            onPageClick: function (event, page) {
                pageCofig.pageIndex = page;
                setTimeout(callback, 200);
            }
        });
    }
    function paginationSearchMutiplePages(totalRow, callback) {
           var totalPage = Math.ceil(totalRow / pageCofig.pageSize);
        $('#paginationSearchMutiplePages').twbsPagination({
                totalPages: totalPage,
                visiblePages: 10,
            onPageClick: function (event, page) {
                pageSearchCofig.pageIndex = page;
                    setTimeout(callback, 500);
                }
            });
    }
    function paginationSearchOnePage(callback) {
        $('#paginationSearchOnePage').twbsPagination({
                totalPages: 1,
                visiblePages: 10,
                onPageClick: function (event, page) {
                    pageSearchOneCofig.pageIndex = page;
                    setTimeout(callback, 500);
                }
            });
    }

    $("#searchUser").keyup(function () {
        searchUser();
    });
    function searchUser() {
        $("#tableUser").find('.dataTable').remove();
        var searchFullname = $("#searchUser").val();
        $.ajax({
            type: "POST",
            url: "/Admin/UserAccount/Search",
            data: '{searchUser: "' + searchFullname + '", page: ' + pageSearchCofig.pageIndex + ', pageSize: ' + pageSearchCofig.pageSize +' }',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (response.users.length > 0) {
                    if (searchFullname == "") {
                        $("#pagination").show();
                        $("#paginationSearchMutiplePages").hide();
                        $("#paginationSearchOnePage").hide();
                        $("#tableUser").find('.dataTable').remove();
                        $.ajax({
                            type: "GET",
                            url: "/Admin/UserAccount/LoadData",
                            data: {
                                page: pageCofig.pageIndex,
                                pageSize: pageCofig.pageSize
                            },
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function (response) {
                                var row = "";
                                for (var i = 0; i < response.data.length; i++) {
                                    row += "<tr class='dataTable' id='" + response.data[i].UserId + "'>" + "<td>" + response.data[i].FullName + "</td>" + "<td>" + response.data[i].UserName + "</td>" + "<td>" + response.data[i].Email + "</td>" + "<td>" + response.data[i].PhoneNumber + "</td>" + "<td> <a href='/Admin/UserAccount/Details/" + response.data[i].UserId + "' class='btn btn-info' style = 'font-weight: bold'>Details</a> <a href='/Admin/UserAccount/Edit/" + response.data[i].UserId + "' class='btn btn-success' style = 'font-weight: bold'>Edit</a> <a onclick = deleteUser(" + response.data[i].UserId + ") class='btn btn-danger' style = 'font-weight: bold; color: white'>Delete</a> </td>" + "</tr>"
                                }
                                $("#tableUser").append(row);
                                pagination(response.total, function () {
                                    loadData();
                                })
                            }
                        });
                    } else {
                        $("#tableUser").find('.dataTable').remove();
                        var row = "";
                        for (var i = 0; i < response.data.length; i++) {
                            row += "<tr class='dataTable' id='" + response.data[i].UserId + "'>" + "<td>" + response.data[i].FullName + "</td>" + "<td>" + response.data[i].UserName + "</td>" + "<td>" + response.data[i].Email + "</td>" + "<td>" + response.data[i].PhoneNumber + "</td>" + "<td> <a href='/Admin/UserAccount/Details/" + response.data[i].UserId + "' class='btn btn-info' style = 'font-weight: bold'>Details</a> <a href='/Admin/UserAccount/Edit/" + response.data[i].UserId + "' class='btn btn-success' style = 'font-weight: bold'>Edit</a> <a onclick = deleteUser(" + response.data[i].UserId + ") class='btn btn-danger' style = 'font-weight: bold; color: white'>Delete</a> </td>" + "</tr>"
                        }
                        $("#tableUser").append(row);
                        $("#pagination").hide();
                        $("#paginationDelete").hide();
                        if (response.total > 2) {
                            $("#paginationSearchMutiplePages").show();
                            $("#paginationSearchOnePage").hide();
                            paginationSearchMutiplePages(response.total, function () {
                                searchUser();
                            });
                        } else {
                            if (response.total == 0) {
                                $("#paginationSearchOnePage").hide();
                            } else {
                                $("#paginationSearchMutiplePages").hide();
                                $("#paginationSearchOnePage").show();
                            paginationSearchOnePage(function () {
                                searchUser();
                            });
                            }
                        }
                    }
                } else {
                    swal({
                        title: "Nothing to search !",
                        text: "Please add new user",
                        icon: "error",
                        button: "Got it",
                        dangerMode: false
                    }).then((logOut) => {
                        if (logOut) {
                           window.location.replace("/Admin/UserAccount/Create");
                        }
                    });
                }
            }
        });
    }
    function deleteUser(userId) {
        swal({
            title: "Are you sure you want to delete?",
            text: "Once deleted, you will not be able to recover this user!",
            icon: "warning",
            buttons: true,
            dangerMode: true,
        }).then((logOut) => {
            if (logOut) {
                $.ajax({
                    type: "POST",
                    url: "/Admin/UserAccount/Delete",
                    data: '{userId: "' + userId + '" }',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        if (response) {
                            $("#" + userId).remove();
                            loadData();
                                setTimeout(function () {
                                    swal({
                                        title: "Poof! User has been deleted!",
                                        icon: "success",
                                        button: true,
                                        dangerMode: false,
                                    });
                                }, 100);
                        } else {
                            swal("Can not delete user!", "error");
                        }
                    }
                });


            }
        });
    }

</script>
